---
import Layout from '~/layouts/Layout.astro'
import { sanity } from '~/lib/sanity'
import { renderPortableText } from '~/lib/renderPortableText'

export async function getStaticPaths() {
  const slugs = await sanity.fetch(`*[_type == "post" && defined(slug.current)][]{
    "params": { "slug": slug.current }
  }`)
  return slugs
}

const { slug } = Astro.params

const post = await sanity.fetch(`*[_type == "post" && slug.current == $slug][0] {
  title,
  publishedAt,
  mainImage {
    asset->{
      url
    }
  },
  body
}`, { slug })

const htmlBody = renderPortableText(post.body)
---

<Layout title={post.title}>
  <article class="prose lg:prose-xl">
    <h1>{post.title}</h1>
    <p><em>{new Date(post.publishedAt).toLocaleDateString()}</em></p>
    {post.mainImage?.asset?.url && (
      <img src={post.mainImage.asset.url} alt={post.title} />
    )}
    <div set:html={htmlBody} />
  </article>
</Layout>
